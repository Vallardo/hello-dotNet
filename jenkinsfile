pipeline {
    agent any
    environment {
        AWS_DEFAULT_REGION = 'us-west-2'  // Set your AWS region here
        // Explicitly define the known hosts file location
        SSH_KNOWN_HOSTS = "${env.WORKSPACE}/known_hosts"
    }

    options {
      timeout(time: 5, unit: 'MINUTES') 
  }

    stages {
        stage('Clone Repository') {
            steps {
                checkout scm
            }
        }

        stage('Build the dotNet app') {
            steps {
                echo 'Building...'
                bat 'dotnet build' //Commands for the build process
            }
        }

        stage('Build Docker image') {
            steps {
                echo 'Building Docker image...'
                bat 'docker build -t basicdotnetapi .' //"basicdotnetapi" is the name of my app
            }
        }

        stage('Authenticate with AWS ECR'){

            steps{
                echo 'Authenticating with AWS ECR...'
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'vj-aws-dev-creds']]) {
                    script {
                        bat 'aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 177555066587.dkr.ecr.us-west-2.amazonaws.com'
                    }
                }
                
            }
            
        }

        stage('Tag the image') {
            steps {
                echo 'Tagging the image...'
                //Tha tag given to this image is "latest" but it could be anything like 1.0 etc..
                bat 'docker tag basicdotnetapi:latest 177555066587.dkr.ecr.us-west-2.amazonaws.com/vallardo-dotnetapp:latest'
            }
        }

        stage('Push the image to Amazon Elastic Container Registry (ECR)') {
            steps {
                echo 'Pushing the image to Amazon Elastic Container Registry (ECR)...'
                bat 'docker push 177555066587.dkr.ecr.us-west-2.amazonaws.com/vallardo-dotnetapp:latest'
            }
        }

        /*stage('Launch EC2 Instance') {
            steps {
                script {
                    // Define the AMI ID, Instance Type, Security Group ID, Subnet ID, and Key Pair
                    //def amiId = 'ami-075686beab831bb7f'  //ubuntu/images/hvm-ssd-gp3/ubuntu-noble-24.04-amd64-server-20250305
                    def amiId = 'ami-087f352c165340ea1'    //Amazon Linux 2023 AMI 2023.7.20250331.0 x86_64 HVM kernel-6.1 
                    def instanceType = 't2.micro'        // Replace with your desired instance type
                    session manager is the recommended way to authenticate, so no keyName is required, a flag saying no-key is require
                    //def keyName = 'vallardo_ec2'            // Replace with your EC2 Key Pair  //not used in real project
                    def securityGroupId = 'sg-0abcd1234efgh5678'  // Replace with your Security Group ID
                    def subnetId = 'subnet-12345abcde67890fg'     // Replace with your Subnet ID
                    def tagName = 'MyEC2Instance'         // Name tag for the instance

                    // Launch EC2 Instance using AWS CLI command
                    bat """
                        aws ec2 run-instances \
                            --image-id ${amiId} \
                            --count 1 \
                            --instance-type ${instanceType} \
                            --key-name ${keyName} \optional
                            --security-group-ids ${securityGroupId} \
                            --subnet-id ${subnetId} \
                            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=${tagName}}]' \
                            --output json
                    """
                }
            }
        }
        
        stage('Describe EC2 Instance') {
            steps {
                script {
                    // Get the instance ID of the launched instance
                    //def instanceId = sh(script: "aws ec2 describe-instances --query 'Reservations[0].Instances[0].InstanceId' --output text", returnStdout: true).trim()
                    echo "Launched EC2 instance with ID: ${instanceId}"
                }
            }
        }*/
        
        stage('Connect to EC2 via SSH'){
            steps{
                withCredentials([sshUserPrivateKey(credentialsId: 'vj_aws_ec2_ssh', keyFileVariable: 'PK')]) {
                    echo 'Inside sshUserPrivateKey credentials'
                    echo "${PK}"
                    //bat '''
                    //                REM Create the .ssh directory if it does not exist
                    //                if not exist %USERPROFILE%\\.ssh mkdir %USERPROFILE%\\.ssh
                    //                
                    //                REM Add the server's SSH keys to the known_hosts file
                    //                ssh-keyscan -t rsa,dsa ec2-44-245-155-98.us-west-2.compute.amazonaws.com >> %USERPROFILE%\\.ssh\\known_hosts
                    //            '''
                    //sh 'git -c core.sshCommand="ssh -i $PK" submodule update --init'
                    //bat "ssh -vv -i \"${pemFilePath}\" -T ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com \"uptime\""
                    bat "ssh -vv -i ${PK} -T ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com \"uptime\"" 
                }

                //withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'vj-aws-dev-creds']]) {
                //    script{
                //        echo 'Connecting to EC2 via ssh...'
                //        def secretValue = bat(script: '''aws secretsmanager get-secret-value --secret-id vallardo-plain-ec2-pem --query SecretString --output text''', returnStdout: true).trim()
                        // Write the PEM content to a file in the workspace
                        //Note: Jenkins does not allow writting files with .pem extension 
                //        def pemFilePath = "${env.WORKSPACE}\\vallardo-plain-ec2-pem"

                //        writeFile file: pemFilePath, text: secretValue

                        // Debug: Confirm the file is created
                //        echo "PEM file written to: ${pemFilePath}"
                        //bat "powershell Set-ItemProperty -Path \"${pemFilePath}\" -Name \"IsReadOnly\" -Value $true"
                        //bat 'ssh -i "vallardo-pem" -T ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com "uptime"'
                        //bat "ssh -vv -i \"${pemFilePath}\" -T ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com \"uptime\""
                //        echo 'ABout to call SSH'
                        //bat '''
                        //            REM Create the .ssh directory if it does not exist
                        //            if not exist %USERPROFILE%\\.ssh mkdir %USERPROFILE%\\.ssh
                        //            
                        //            REM Add the server's SSH keys to the known_hosts file
                        //            ssh-keyscan -t rsa,dsa ec2-44-245-155-98.us-west-2.compute.amazonaws.com >> %USERPROFILE%\\.ssh\\known_hosts
                        //        '''
                        //bat "ssh -vv -i \"${pemFilePath}\" -T ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com \"uptime\""
                        //sshagent(credentials: ['vj_aws_ec2_ssh']) {
                        //    script {
                        //        echo 'ABout to call SSH'
                                
                                
                                /*bat '''
                                    REM Create the .ssh directory if it does not exist
                                    if not exist %USERPROFILE%\\.ssh mkdir %USERPROFILE%\\.ssh
                                    
                                    REM Add the server's SSH keys to the known_hosts file
                                    ssh-keyscan -t rsa,dsa ec2-44-245-155-98.us-west-2.compute.amazonaws.com >> %USERPROFILE%\\.ssh\\known_hosts
                                    
                                    REM Run the SSH command to the EC2 instance
                                    ssh -o StrictHostKeyChecking=no ec2-user@ec2-44-245-155-98.us-west-2.compute.amazonaws.com "hostname"
                                '''*/
                        //    }
                    //}
                //}
                
                
            }
        }

        stage('Install Docker on the EC2 instance'){
            steps{
                echo 'Installing Docker in EC2...'
                bat 'sudo yum update -y'
                bat 'sudo yum install -y docker'
                bat 'sudo service docker start'
                bat 'sudo usermod -aG docker ec2-user'
                bat 'docker --version'
            }
        }

        stage('Pull the Docker image from ECR'){
            steps{
                echo 'Pulling docker image from ECR ...'
                //This steps assumes that the EC2 instance has a role assigned with permissions to log in to AWS ECR
                bat 'aws ecr get-login-password --region us-west-2 | sudo docker login --username AWS --password-stdin 177555066587.dkr.ecr.us-west-2.amazonaws.com'
                bat 'sudo docker pull 177555066587.dkr.ecr.us-west-2.amazonaws.com/vallardo-dotnetapp:latest'
            }
        }

        stage('Run the Docker container'){
            steps{
                echo 'Running the Docker container...'
                bat 'sudo docker run -d -p 80:8080 177555066587.dkr.ecr.us-west-2.amazonaws.com/vallardo-dotnetapp:latest'
            }
        }
    }
}
